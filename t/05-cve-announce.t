use strict;
use v5.42;

use File::Copy qw(copy);
use File::Path qw(make_path);
use File::Temp qw(tempdir);
use Test::More;

use lib 'lib';
use CPANSec::CVE ();

my $cve = CPANSec::CVE->from_yaml_file('t/var/CVE-2025-40916.yaml');
my $announce_from_model = $cve->to_announce_text;
like($announce_from_model, qr/^Subject: CVE-2025-40916:/m, 'facade renders announce text');

# The announce starts from a full CVE projection and should include title + references.
like($announce_from_model, qr/^References$/m, 'facade announce includes references section');

my $root = tempdir(CLEANUP => 1);
my $cves = "$root/cves";
make_path($cves);
my $target = "$cves/CVE-2025-40916.yaml";
copy('t/var/CVE-2025-40916.yaml', $target) or die "copy failed: $!";

my $cli_text = qx(scripts/cna --cpansec-cna-root '$root' announce CVE-2025-40916 2>&1);
is($? >> 8, 0, 'cna announce succeeds');
is($cli_text, $announce_from_model, 'cli output matches facade output');

done_testing();
