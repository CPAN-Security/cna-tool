use strict;
use v5.36;

use File::Path qw(make_path);
use File::Temp qw(tempdir tempfile);
use JSON::PP qw(decode_json);
use Test::More;

my $yaml = <<'YAML';
cpansec:
  cve: CVE-1900-9999
  distribution: Example-Dist
  module: Example::Module
  author: EXAMPLE
  affected:
    - "1.0 <= 2.0"
  title: Example::Module {{VERSION_RANGE}} for Perl has an issue
  description: |
    Example::Module {{VERSION_RANGE}} for Perl has an issue.
    Example description.
  cwes:
    - "CWE-330: Use of Insufficiently Random Values"
  solution:
    - First solution
    - Second solution
  mitigation:
    - First workaround
    - Second workaround
  impacts:
    - CAPEC-115 Authentication Bypass
  credits:
    - type: reporter
      value: Alice
    - type: finder
      value: Bob
      lang: en
  timeline:
    - time: 2025-01-01
      value: Reported
  references:
    - link: https://example.com/patch
      tags: [patch]
    - link: https://example.com/related
      tags: [related]
    - link: https://example.com/issue
      tags: [issue-tracking]
    - link: https://example.com/release
      tags: [release-notes]
    - link: https://example.com/tech
      tags: [technical-description]
    - link: https://example.com/mitigation
      tags: [mitigation]
    - link: https://example.com/vendor
      tags: [advisory]
    - link: https://example.com/third-party
      tags: [third-party-advisory]
    - link: https://example.com/vdb
      tags: [vdb-entry]
YAML

my $cve = 'CVE-1900-9999';
my $root = tempdir(CLEANUP => 1);
my $cves = "$root/cves";
make_path($cves);
my $tmp = "$cves/$cve.yaml";
open(my $fh, ">", $tmp) or die "Cannot write $tmp: $!";
print {$fh} $yaml;
close($fh);

my $validate_out = qx(scripts/cna --cpansec-cna-root '$root' check $cve 2>&1);
is($? >> 8, 0, "validate mode succeeds");
like($validate_out, qr/^Summary: /m, "check prints summary");

my ($emit_err_fh, $emit_err) = tempfile();
close($emit_err_fh);
my $json_out = qx(scripts/cna --cpansec-cna-root '$root' emit $cve --cna-container-only 2>'$emit_err');
is($? >> 8, 0, "cna-container-only generation succeeds");
my $cna = decode_json($json_out);

is(scalar(@{$cna->{solutions} // []}), 2, "array solution maps to two solutions");
is(scalar(@{$cna->{workarounds} // []}), 2, "array mitigation maps to two workarounds");
like($cna->{title}, qr/\bversions from 1\.0 through 2\.0\b/, "VERSION_RANGE interpolates in title");
like($cna->{descriptions}[0]{value}, qr/\bversions from 1\.0 through 2\.0\b/, "VERSION_RANGE interpolates in description");
unlike($cna->{title}, qr/\{\{\s*VERSION_RANGE\s*\}\}/, "title has no unresolved VERSION_RANGE token");
is(scalar(@{$cna->{problemTypes} // []}), 1, "CWE entries are mapped");
is($cna->{problemTypes}[0]{descriptions}[0]{cweId}, 'CWE-330', "CWE id parsed");
is(scalar(@{$cna->{impacts} // []}), 1, "impacts are mapped");
is(scalar(@{$cna->{credits} // []}), 2, "credits are mapped");
is(scalar(@{$cna->{timeline} // []}), 1, "timeline is mapped");
is($cna->{timeline}[0]{time}, '2025-01-01T00:00:00Z', "date-only timeline normalizes to midnight UTC");

my @all_tags = map { @{$_->{tags} // []} } @{$cna->{references} // []};
my %seen = map { $_ => 1 } @all_tags;
for my $tag (qw(patch related issue-tracking release-notes technical-description mitigation vendor-advisory third-party-advisory vdb-entry)) {
  ok($seen{$tag}, "reference tag '$tag' accepted");
}

done_testing();
