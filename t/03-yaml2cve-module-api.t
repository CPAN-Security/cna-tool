use strict;
use v5.42;

use JSON::PP qw(decode_json);
use Test::More;

use lib 'lib';
use CPANSec::CNA ();
use CPANSec::CVE::YAML2CVE ();

my $converter = CPANSec::CVE::YAML2CVE->new;

ok(-f $converter->schema_file, 'default YAML schema path exists');
ok(-f $converter->cve_schema_file, 'default CVE schema path exists');

$converter->validate_yaml_file('t/var/CVE-2025-40916.yaml');
pass('validate_yaml_file succeeds');

my $json_text = $converter->convert_yaml_file_to_json('t/var/CVE-2025-40916.yaml');
my $json_obj = decode_json($json_text);

is($json_obj->{cveMetadata}{cveId}, 'CVE-2025-40916', 'class converts YAML to full CVE record JSON');
is(
  $json_obj->{containers}{cna}{x_generator}{engine},
  'cpansec-cna-tool ' . CPANSec::CNA->VERSION,
  'generator engine uses CPANSec::CNA version',
);

my $cna_text = $converter->convert_yaml_file_to_json('t/var/CVE-2025-40916.yaml', cna_only => 1);
my $cna_obj = decode_json($cna_text);

ok(ref($cna_obj->{affected}) eq 'ARRAY', 'class supports cna_only output');

done_testing();
